<?xml version="1.0" encoding="UTF-8"?><record_update table="sysauto_script">
    <sysauto_script action="INSERT_OR_UPDATE">
        <active>false</active>
        <condition/>
        <conditional>false</conditional>
        <name>Tasker - Reset Tasker Bookmarks</name>
        <run_as/>
        <run_as_tz/>
        <run_dayofmonth>1</run_dayofmonth>
        <run_dayofweek>1</run_dayofweek>
        <run_period/>
        <run_start>2018-05-03 16:21:56</run_start>
        <run_time>1970-01-01 08:00:00</run_time>
        <run_type>once</run_type>
        <script><![CDATA[gs.info("DiscoverTasker resetting Bookmarks template");


var baseUser = ''; //70070c27db201b003a8d6be3ca96193c Rob Joy
var baseUser_Name = '';//rjoy';

ResetAllUserBookmarks(baseUser, baseUser_Name);

function ResetAllUserBookmarks(pbaseUser, pbaseUser_Name){
	// Query the database and find all user
	// TODO: filter by role x_153465_discovert.tasker_user
	var userID = null;
	var allUsers = new GlideRecord('sys_user');
	allUsers.addEncodedQuery('user_name!=' + pbaseUser_Name);
	allUsers.query();
	
	
	while (allUsers.next()) {
		
		userID = allUsers.getValue('sys_id');
		gs.info("DiscoverTasker resetting Bookmarks template : userID "+ allUsers.getValue('user_name'));
		
		DeleteBookmarkUpdatedByAdmin(userID);
		AddBookmarkTemplate(pbaseUser, userID);
		
	}
}

function DeleteBookmarkUpdatedByAdmin(pUser){
	// Query the database and find user's bookmark
	gs.info("DiscoverTasker copying Bookmarks template: DeleteBookmarkByAdmin " + pUser);
	gs.info("DiscoverTasker pUser" + pUser);
	
	// RAJ - STRY0011695 - change to use Glide Aggregate
	var bookMarkCount = 0;
	var gaBookmarkPerUser = new GlideAggregate('sys_ui_bookmark');
	gaBookmarkPerUser.addAggregate('COUNT');
	gaBookmarkPerUser.query();
	if(gaBookmarkPerUser.next()){
		bookMarkCount = gaBookmarkPerUser.getAggregate('COUNT');
	}
	
	var bookmarkperUser = new GlideRecord('sys_ui_bookmark');
	bookmarkperUser.addQuery('user', pUser);
	bookmarkperUser.addEncodedQuery('sys_created_by!=' + pUser);
	
	bookmarkperUser.query();
	gs.info("DiscoverTasker copying Bookmarks template: bookMarkCount " + bookMarkCount );
	bookmarkperUser.deleteMultiple();
	
}

function AddBookmarkTemplate(pbaseUser, pnewUser){
	// Query the database and find bookmarks from the base user
	var bookmarkBase = new GlideRecord('sys_ui_bookmark');
	bookmarkBase.addQuery('user', pbaseUser); // TODO: Change it to 'Robert Joy'
	bookmarkBase.query();
	
	// Create same bookmarks for the new user
	while (bookmarkBase.next()) {
		if (bookmarkBase.getValue('title') != 'Home')
			AddBookmark(bookmarkBase, pnewUser);
	}
}


function AddBookmark(bookmarkBase, pnewuser){
	
	var newBookmark = new GlideRecord('sys_ui_bookmark');
	newBookmark.initialize();
	newBookmark.user = pnewuser;
	newBookmark.title = bookmarkBase.getValue('title');
	newBookmark.image = bookmarkBase.getValue('image');
	newBookmark.icon = bookmarkBase.getValue('icon');
	newBookmark.color = bookmarkBase.getValue('color');
	newBookmark.order = bookmarkBase.getValue('order');
	newBookmark.module = bookmarkBase.getValue('module');
	newBookmark.url = bookmarkBase.getValue('url');
	newBookmark.insert();
	
}
]]></script>
        <sys_class_name>sysauto_script</sys_class_name>
        <sys_created_by>KTorres</sys_created_by>
        <sys_created_on>2018-05-03 16:23:19</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>c4fb779edbf55700bb8ee536ca9619b0</sys_id>
        <sys_mod_count>37</sys_mod_count>
        <sys_name>Tasker - Reset Tasker Bookmarks</sys_name>
        <sys_package display_value="Tasker" source="x_153465_discovert">c6b1162d4fc10300303dc3818110c7b1</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Tasker">c6b1162d4fc10300303dc3818110c7b1</sys_scope>
        <sys_update_name>sysauto_script_c4fb779edbf55700bb8ee536ca9619b0</sys_update_name>
        <sys_updated_by>KTorres</sys_updated_by>
        <sys_updated_on>2018-11-10 21:17:16</sys_updated_on>
        <upgrade_safe>false</upgrade_safe>
    </sysauto_script>
</record_update>
