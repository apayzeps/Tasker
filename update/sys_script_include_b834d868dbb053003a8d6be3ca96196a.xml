<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_153465_discovert.getTaskerSubTaskProgress</api_name>
        <client_callable>false</client_callable>
        <description>This script is used to determine the lowest state of child progress.</description>
        <name>getTaskerSubTaskProgress</name>
        <script><![CDATA[var getTaskerSubTaskProgress = Class.create();
getTaskerSubTaskProgress.prototype = {
	initialize: function() {
	},
	
	getSubTaskProgress: function(parentId)
	{
		var stateSubTaskProgress = -5;
// RAJ - decided not to automatically count taskers of type review.
// Since Review steps also go through acceptances, it was decided not to count them until the tasker is in the In Review State
// 		// Get id of the Reivew Type, NOTE: this is under review for a better way
// 		var jqChildType = new GlideRecord('x_153465_discovert_tasker_type');
// NOTE: if this is added back in later, do the following:
//       - Drop the lookup in the Tasker Type Table
//       - on the Tasker table, change to add another "addQuery" line for work_item_type equal to the Review work item type
// 		jqChildType.addQuery('tasker_type','Review Tasker');
// 		jqChildType.query();
// 		if(jqChildType.next()){
// 			var gaCountChildReviewType = new GlideAggregate('x_153465_discovert_route_task_instance');
// 			//Query child tables for all records with current parent.
// 			gaCountChildReviewType.addAggregate('COUNT');
// 			gaCountChildReviewType.addQuery('parent', parentId);
// 			// child Tasker is a Review Tasker
// 			gaCountChildReviewType.addQuery('tasker_type', jqChildType.sys_id);
// 			// review is not "Closed Complete" - 3
// 			// review is not "Closed Incomplete" - 4
// 			// review is not "Cancelled" - 7
// 			gaCountChildReviewType.addQuery('state',"NOT IN", "3,4,7");
			
// 			gaCountChildReviewType.query();

// 			if(gaCountChildReviewType.next()) 
// 				countChildrenInReview = parseInt(gaCountChildReviewType.getAggregate('COUNT'));
// 		}
// NOTE: if the above logic were added back in, then the query below would need to be modified to remove all "Tasker's with work_item_type of review or those items would be counted multiple times.


		var grSubTasks = new GlideRecord('x_153465_discovert_route_task_instance');
		grSubTasks.addQuery('parent', parentId);
		grSubTasks.orderBy('state_order');
		grSubTasks.query();

		if (grSubTasks.next())
			stateSubTaskProgress = grSubTasks.state;
		
		return stateSubTaskProgress;
	},

	countClosed: function(parentId)
	{

		var countClosed = 0;

		var gaCountChildrenClosed = new GlideAggregate('x_153465_discovert_route_task_instance');
		//Query child tables for all records with current parent.
		gaCountChildrenClosed.addAggregate('COUNT');
		gaCountChildrenClosed.addQuery('parent', parentId);
		// Count all closed states
		// "Closed Complete" - 3
		// "Closed Incomplete" - 4
		// "Cancelled" - 7
		gaCountChildrenClosed.addQuery('state',"IN", "3,4,7");
		
		gaCountChildrenClosed.query();
		
		if(gaCountChildrenClosed.next()) 
			countClosed += gaCountChildrenClosed.getAggregate('COUNT');
		
		return countClosed;
	},
	
	type: 'getTaskerSubTaskProgress'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>rjoy</sys_created_by>
        <sys_created_on>2018-03-08 22:01:13</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>b834d868dbb053003a8d6be3ca96196a</sys_id>
        <sys_mod_count>29</sys_mod_count>
        <sys_name>getTaskerSubTaskProgress</sys_name>
        <sys_package display_value="Tasker" source="x_153465_discovert">c6b1162d4fc10300303dc3818110c7b1</sys_package>
        <sys_policy>protected</sys_policy>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Tasker">c6b1162d4fc10300303dc3818110c7b1</sys_scope>
        <sys_update_name>sys_script_include_b834d868dbb053003a8d6be3ca96196a</sys_update_name>
        <sys_updated_by>rjoy</sys_updated_by>
        <sys_updated_on>2018-03-15 20:04:58</sys_updated_on>
    </sys_script_include>
</record_update>
